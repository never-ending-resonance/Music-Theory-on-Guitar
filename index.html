<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Theory Tool</title>
    <style>
        /* ==================== [1. BASE LAYOUT AND RESET] ====================
           - Import font, set up base body background, layout containers, and header
        */
        @import url('https://fonts.googleapis.com/css?family=UnifrakturCook:700&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'UnifrakturCook', 'Old English Text MT', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #185cdb 0%, #7621ca 100%);
            min-height: 100vh; padding: 20px;
            zoom: 0.33; /* Zoom out 3 times larger (1/3 = 0.33) */
        }
        .container {
            max-width: 1600px; margin: 0 auto; background: white;
            border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            font-family: 'UnifrakturCook', 'Old English Text MT', serif;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white; padding: 30px; text-align: center;
            font-family: 'UnifrakturCook', 'Old English Text MT', serif;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        .main-content { padding: 30px; font-family: 'UnifrakturCook', 'Old English Text MT', serif;}
        .grid {
            display: grid; grid-template-columns: 2fr 1fr; gap: 24px;
            font-family: 'UnifrakturCook', 'Old English Text MT', serif;
        }

        .staff-wrapper {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 14px;
        }

        .staff-card {
            background: #ffffff;
            border: 2px solid #2c3e50;
            border-radius: 14px;
            padding: 18px;
            max-width: 700px;
            width: 100%;
            box-shadow: 0 4px 14px rgba(0,0,0,0.08);
        }

        .staff-card svg {
            width: 100%;
            height: auto;
        }

        .home-menu {
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            padding: 50px 20px;
        }

        .home-menu .button {
            width: 280px;
            text-align: center;
            font-size: 1.2em;
        }

        /* ==================== [2. TOOL UI COMPONENTS] ====================
           - Card style for each tool, inputs, buttons, output result
        */
        .tool-section {
            margin-bottom: 40px; padding: 25px;
            border: 2px solid #08313b; border-radius: 10px;
            background: #3a91e7;
        }
        .tool-section h2 {
            color: #2c3e50; margin-bottom: 20px;
            font-size: 1.8em; border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .input-group { margin-bottom: 20px; }
        .input-group label {
            display: block; margin-bottom: 8px; font-weight: bold;
            color: #34495e;
        }
        .input-group select, .input-group input {
            width: 100%; padding: 12px;
            border: 2px solid #bdc3c7; border-radius: 8px; font-size: 16px;
            transition: border-color 0.3s;
        }
        .input-group select:focus, .input-group input:focus {
            outline: none; border-color: #3498db;
        }
        .button {
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            color: white; border: none; padding: 12px 25px;
            border-radius: 8px; font-size: 16px; cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        .result {
            margin-top: 20px; padding: 20px; background: #e8f5e8;
            border-left: 5px solid #27ae60; border-radius: 5px;
            font-family: 'UnifrakturCook', 'Old English Text MT', 'Courier New', monospace;
        }

        /* ==================== [3. FRETBOARD SECTION] ====================
           - Guitar fretboard visualization, including notes, dot styles, strings, etc.
        */
        .fretboard {
            font-family: 'Segoe UI', Arial, sans-serif; background: #011822;
            color: rgb(106, 81, 218); padding: 45px 38px 52px 38px;
            border-radius: 14px; min-width: 1600px; max-width: 100%;
            min-height: 375px; overflow-x: auto; margin-bottom: 22px;
            display: block;
        }
        .fretboard-header { display: flex; margin-bottom: 12px; }
        .fretboard-header div {
            width: 70px; height: 48px;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 18px; color: #f5f5f5;
        }
        .fretboard-string { display: flex; margin-bottom: 9px; }
        .fretboard-string div {
            width: 57px; height: 48px;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
        }
        .fretboard-string .string-label {
            width: 70px; margin-right: 12px;
            background: #342017; font-weight: bold; color: #f7f2ea;
            border-radius: 8px;
        }
        .fretboard-string .string-line {
            height: 4px; width: 100%; background: #000; border-radius: 2px;
        }
        .fretboard-grid {
            position: relative; display: inline-block;
        }
        .fretboard-octave-lines {
            position: absolute; top: 0; left: 0; pointer-events: none;
        }
        .fret-cell {
            border-radius: 12px;
            font-weight: 600;
            letter-spacing: 0.4px;
            background: rgba(255,255,255,0.82);
            color: #0a2235;
            box-shadow: inset 0 0 2px rgba(0,0,0,0.12);
        }
        .fret-cell.in-scale {
            background: #1c3f74;
            color: #f4fbff;
        }
        .fret-cell.root {
            background: #4ab3ff;
            color: #012840;
            box-shadow: 0 0 12px rgba(74,179,255,0.55);
        }
        .fret-cell.out-of-scale {
            background: rgba(255,255,255,0.18);
            color: rgba(255,255,255,0.52);
        }
        /* Black string line */
        .fretboard-string .string-line {
            height: 3px; width: 100%; background: #000; border-radius: 2px;
        }
        .note-dot {
            display: flex; align-items: center; justify-content: center; background: none;
        }
        .note-empty { color: #33e0ec; font-size: 18px; }

        /* ==================== [4. ADVANCED VISUAL ELEMENTS] ====================
           - Star twinkle animation for dot notes, subgrid visualizations, bullets, etc
        */
        .note-dot .star-dot {
            position: relative; display: inline-block; width: 17px; height: 17px;
            animation: twinkle-star 2s infinite ease-in-out;
        }
        .note-dot .star-dot::before,
        .note-dot .star-dot::after {
            content: '';
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%) rotate(0deg); border-radius: 50%;
            background: radial-gradient(circle at 50% 40%, #fff 65%, #7ffcff 80%, #03d8fd 97%, #00fafc20 100%);
        }
        .note-dot .star-dot::before {
            width: 17px; height: 17px; opacity: 0.96;
            filter: blur(0.5px) drop-shadow(0 0 10px #fff3) drop-shadow(0 0 6px #57fcffbb);
            z-index: 1;
        }
        .note-dot .star-dot::after {
            width: 13px; height: 13px; opacity: 0.83;
            filter: blur(1.2px) drop-shadow(0 0 6px #67fcfc88);
            z-index: 2;
        }
        .note-dot .star-ray {
            position: absolute; left: 50%; top: 50%;
            width: 2px; height: 13px; border-radius: 2px;
            background: linear-gradient(to bottom, #fff, #17e8ff99 80%, transparent 100%);
            transform-origin: center 70%; opacity: 0.78; z-index: 9;
            pointer-events: none; animation: twinkle-ray-flicker 1.7s infinite alternate;
        }
        .note-dot .star-ray.ray-1 { transform: translate(-50%, -50%) rotate(0deg); animation-delay: 0.5s;}
        .note-dot .star-ray.ray-2 { transform: translate(-50%, -50%) rotate(60deg); animation-delay: 0.5s;}
        .note-dot .star-ray.ray-3 { transform: translate(-50%, -50%) rotate(120deg); animation-delay: 0.5s;}
        .note-dot .star-ray.ray-4 { transform: translate(-50%, -50%) rotate(180deg); animation-delay: 0.5s;}
        .note-dot .star-ray.ray-5 { transform: translate(-50%, -50%) rotate(240deg); animation-delay: 0.5s;}
        .note-dot .star-ray.ray-6 { transform: translate(-50%, -50%) rotate(300deg); animation-delay: 0.5s;}

        @keyframes twinkle-star {
            0%, 100%   { filter: brightness(1.3) drop-shadow(0 0 8px #2888c988);}
            40%        { filter: brightness(1.9) drop-shadow(0 0 13px #2aabdf);}
            50%        { filter: brightness(2.3) drop-shadow(0 0 24px #12cbd1);}
            60%        { filter: brightness(1.6) drop-shadow(0 0 10px #034750);}
            80%        { filter: brightness(1.2);}
        }
        @keyframes twinkle-ray-flicker {
            0%, 100% { opacity: 0.80; }
            40%      { opacity: 0.98; }
            53%      { opacity: 0.54; }
            67%      { opacity: 0.77; }
            73%      { opacity: 0.88; }
        }
        .fretboard-large-horizontal {
            width: 100%; overflow-x: auto;
            display: flex; flex-direction: row;
            justify-content: flex-start; align-items: flex-start;
        }
        .subgrids-container {
            display: flex; flex-direction: row; gap: 40px;
            justify-content: flex-start; margin-top: 25px;
        }
        .subgrid-box {
            display: flex; flex-direction: column; align-items: center;
        }
        .subgrid-label {
            margin-bottom: 7px; font-size: 1.18em; font-weight: bold;
            color: #4e2a1e; letter-spacing: 1px;
        }
        .subgrid-5x5 {
            display: grid; grid-template-rows: repeat(5, 1fr);
            grid-template-columns: repeat(5, 1fr); gap: 3px;
            background: #e7e3e0; border: 2.5px solid #4e2a1e;
            border-radius: 7px; width: 110px; height: 110px;
            box-shadow: 0 1px 7px #0003;
        }
        .subgrid-5x5-cell {
            background: #fff; border-radius: 50%; width: 18px; height: 18px;
            margin: auto;
            display: flex; align-items: center; justify-content: center;
            font-size: 13px;
        }
        .subgrid-dot {
            background: #03d5fc; border-radius: 50%; width: 10px; height: 10px; display: inline-block;
        }
        .note-display {
            display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;
        }
        .note-item {
            background: #3498db; color: white; padding: 8px 15px;
            border-radius: 20px; font-weight: bold;
        }
        .frequency-display {
            background: #9b59b6; color: white; padding: 8px 15px;
            border-radius: 20px; font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéµ Music Theory Tool</h1>
            <p>Interactive music theory calculator and guitar fretboard visualizer</p>
        </div>
        <div class="main-content"></div>
    </div>

    <script>
    // ==================== [SECTION 1: DATA, CONSTANTS, AND LIBRARIES] ====================
    // Description: Definitions for notes, intervals, supported scales, pentatonics, and guitar tuning.

    const NOTES = [
        ["C", 261.63], ["C#", 277.18], ["D", 293.66], ["D#", 311.13], ["E", 329.63], ["F", 349.23],
        ["F#", 369.99], ["G", 392.00], ["G#", 415.30], ["A", 440.00], ["A#", 466.16], ["B", 493.88]
    ];
    const NOTE_TO_INDEX = {};
    const NOTE_TO_FREQ = {};
    NOTES.forEach((note, i) => {
        NOTE_TO_INDEX[note[0]] = i;
        NOTE_TO_FREQ[note[0]] = note[1];
    });

        const INTERVALS = {
        0: "Unison", 1: "Minor Second", 2: "Major Second", 3: "Minor Third",
        4: "Major Third", 5: "Perfect Fourth", 6: "Tritone", 7: "Perfect Fifth",
        8: "Minor Sixth", 9: "Major Sixth", 10: "Minor Seventh", 11: "Major Seventh", 12: "Octave"
        };
        const SCALE_MODES = {
        "ionian": [2,2,1,2,2,2,1], "dorian": [2,1,2,2,2,1,2], "phrygian": [1,2,2,2,1,2,2],
        "lydian": [2,2,2,1,2,2,1], "mixolydian": [2,2,1,2,2,1,2], "aeolian": [2,1,2,2,1,2,2],
        "locrian": [1,2,2,1,2,2,2], "harmonic_minor": [2,1,2,2,1,3,1], "melodic_minor": [2,1,2,2,2,2,1]
        };
        const PENTATONIC_MODES = {
        "ionian": [2,2,3,2,3], "dorian": [2,3,2,2,3], "phrygian": [3,2,2,3,2],
        "lydian": [2,2,4,3,1], "mixolydian": [2,3,2,3,2], "aeolian": [3,2,2,3,2], 
        "locrian": [2,3,2,3,2], "harmonic_minor": [2,1,4,1,4], "melodic_minor": [2,1,3,2,4]
    };
    const GUITAR_STRING_TUNING = ['E', 'A', 'D', 'G', 'B', 'E'];

    const NOTE_NAMES = NOTES.map(n => n[0]);
    const NOTE_LETTER_INDEX = { C: 0, D: 1, E: 2, F: 3, G: 4, A: 5, B: 6 };

    function midiToOctave(midi) {
        return Math.floor(midi / 12) - 1;
    }

    function noteNameFromMidi(midi) {
        const octave = midiToOctave(midi);
        const name = NOTE_NAMES[midi % 12];
        return `${name}${octave}`;
    }

    function parseNoteComponents(noteName) {
        const match = noteName.match(/^([A-G])(#{1})?(-?\d+)$/);
        if (!match) return null;
        return {
            letter: match[1],
            accidental: match[2] || '',
            octave: parseInt(match[3], 10)
        };
    }

    function diatonicNumberFromComponents(letter, octave) {
        return octave * 7 + NOTE_LETTER_INDEX[letter];
    }

    const GUITAR_MIN_MIDI = 40; // E2
    const GUITAR_MAX_MIDI = 76; // E5
    const GUITAR_MIDI_NOTES = Array.from({ length: GUITAR_MAX_MIDI - GUITAR_MIN_MIDI + 1 }, (_, idx) => GUITAR_MIN_MIDI + idx);

    let intervalPracticeState = null;
    let intervalSequenceState = null;

    const INTERVAL_ABBREVIATIONS = {
        "Unison": "P1",
        "Minor Second": "m2",
        "Major Second": "M2",
        "Minor Third": "m3",
        "Major Third": "M3",
        "Perfect Fourth": "P4",
        "Tritone": "TT",
        "Perfect Fifth": "P5",
        "Minor Sixth": "m6",
        "Major Sixth": "M6",
        "Minor Seventh": "m7",
        "Major Seventh": "M7",
        "Octave": "P8"
    };

    const STAFF_CONFIG = {
        treble: {
            clefSymbol: 'ùÑû',
            lineSpacing: 12,
            stepUnit: 6,
            baseLineY: 100,
            height: 200,
            leftMargin: 60,
            rightMargin: 40,
            noteSpacing: 48,
            clefFontSize: 56,
            referenceDiatonic: diatonicNumberFromComponents('E', 4),
            minStep: 0,
            maxStep: 8
        },
        bass: {
            clefSymbol: 'ùÑ¢',
            lineSpacing: 12,
            stepUnit: 6,
            baseLineY: 120,
            height: 200,
            leftMargin: 60,
            rightMargin: 40,
            noteSpacing: 48,
            clefFontSize: 56,
            referenceDiatonic: diatonicNumberFromComponents('G', 2),
            minStep: 0,
            maxStep: 8
        }
    };

    // CHORD and BLUES/ARPEGGIO libraries (Extra scale/chord/arp formulas)
    const CHORD_SCALE_LIBRARY = {
        ...SCALE_MODES,
        // Triads
        "major_triad": [4,3], "minor_triad": [3,4], "augmented_triad": [4,4], "diminished_triad": [3,3],
        "sus2": [2,5], "sus4": [5,2],
        // Sevenths
        "maj7": [4,3,4], "min7": [3,4,3], "7": [4,3,3], "dim7": [3,3,3],
        "min7b5": [3,3,4], "m7b5": [3,3,4], "M7b5": [4,3,2],
        // 9ths
        "maj9": [4,3,4,3], "min9": [3,4,3,4], "9": [4,3,3,4],
        // Arpeggios
        "major_arpeggio": [4,3,5], "minor_arpeggio": [3,4,5],
        // Blues
        "major_blues": [2,1,1,3,2,3], "minor_blues": [3,2,1,1,3,2], "dominant_blues": [2,1,1,2,2,2,2]
    };

    // ==================== [SECTION 2: CORE MUSIC THEORY FUNCTIONS] ====================
    // Description: Core theory utilities for interval calculation, scale building, frequency, etc.

    /**
     * Returns the interval/semitone distance and name between two notes.
     */
    function getInterval(note1, note2) {
        let idx1 = NOTE_TO_INDEX[note1], idx2 = NOTE_TO_INDEX[note2];
        if (typeof idx1 === "undefined" || typeof idx2 === "undefined") {
            console.error(`Invalid note: ${note1}, ${note2}`);
            throw new Error(`Invalid note: ${note1}, ${note2}`);
        }
        let distance = (idx2 - idx1 + 12) % 12;
        let intervalName = INTERVALS[distance] !== undefined ? INTERVALS[distance] : `${distance} semitones`;
        return [distance, intervalName];
    }

    /**
     * Builds array of scale note names starting from root for a mode or pentatonic
     */
        function buildScale(root, scaleType) {
        let intervals, isPentatonic = scaleType.includes('pentatonic');
        if (isPentatonic) {
            let baseType = scaleType.replace('_pentatonic','');
            intervals = PENTATONIC_MODES[baseType] || PENTATONIC_MODES['ionian'];
            } else {
                intervals = SCALE_MODES[scaleType] || SCALE_MODES['ionian'];
            }
        let notes = [];
        let idx = NOTE_TO_INDEX[root];
        if(typeof idx === "undefined") throw new Error("Invalid root note: " + root);
        notes.push(NOTES[idx][0]);
        intervals.forEach(step => {
            idx = (idx + step) % 12;
            notes.push(NOTES[idx][0]);
        });
        if (isPentatonic && notes.length > 5) return notes.slice(0,5);
        return notes;
    }

    /**
     * Returns frequency for note, octave.
     */
    function getFrequency(note, octave) {
        if (!(note in NOTE_TO_FREQ)) throw new Error("Invalid note name: " + note);
        if (isNaN(octave) || octave < 0 || octave > 8) throw new Error("Invalid octave (0-8)");
        const baseFreq = NOTE_TO_FREQ[note];
        return baseFreq * Math.pow(2, octave - 4);
    }

    /**
     * Returns note name for a given open string note and fret.
     */
    function getFretNote(openNote, fret) {
        let idx = NOTE_TO_INDEX[openNote];
        if (typeof idx === "undefined") throw new Error("Invalid open string note: " + openNote);
        let noteAtFret = (idx + fret) % 12;
        return NOTES[noteAtFret][0];
    }

    /**
     * Builds a scale/chord/arpeggio using a preset formula or supplied intervals.
     */
    function buildCustomScale(root, scaleType, customIntervals) {
        let intervals;
        if (customIntervals && Array.isArray(customIntervals)) {
            intervals = customIntervals;
        } else {
            intervals = CHORD_SCALE_LIBRARY[scaleType] || SCALE_MODES[scaleType] || SCALE_MODES['ionian'];
        }
        let notes = [];
            let idx = NOTE_TO_INDEX[root];
        if(typeof idx === "undefined") throw new Error("Invalid root note: " + root);
        notes.push(NOTES[idx][0]);
        for(let step of intervals) {
            idx = (idx + step) % 12;
                notes.push(NOTES[idx][0]);
            }
            return notes;
        }

    /**
     * Parses a string "2,2,1,2" into [2,2,1,2].
     */
    function parseIntervalInput(str) {
        if (typeof str !== "string") return null;
        let arr = str.split(',').map(s => parseInt(s.trim(), 10)).filter(x => !isNaN(x));
        return arr.length ? arr : null;
    }

    function buildFretboardHtml({ root, title, subtitle, notes, fretMax = 19 }) {
        const guitarTuning = ['E', 'A', 'D', 'G', 'B', 'E'];
        const normalizedRoot = normalizeNoteName(root);
        const normalizedNotes = Array.isArray(notes) ? notes.map(normalizeNoteName) : [];
        const noteSet = new Set(normalizedNotes);

        const fretLimit = typeof fretMax === "number" ? fretMax : 19;

        let html = '';
        if (title !== null && title !== undefined) {
            html += `<h3>${title}</h3>`;
        }
        if (subtitle) {
            html += `<p>${subtitle}</p>`;
        }

        html += `<div class="fretboard-grid">`;
        html += `<div class="fretboard-header"><div>String</div>`;
        for (let f = 0; f <= fretLimit; f++) {
            html += `<div>${f}</div>`;
        }
        html += `</div>`;

        for (let s = guitarTuning.length - 1; s >= 0; s--) {
            const stringNum = guitarTuning.length - s;
            const openNote = guitarTuning[s];

            html += `<div class="fretboard-string">`;
            html += `<div class="string-label">${stringNum}</div>`;

            for (let f = 0; f <= fretLimit; f++) {
                const note = getFretNote(openNote, f);
                const normalizedNote = normalizeNoteName(note);
                const isRoot = normalizedNote === normalizedRoot;
                const isScaleNote = noteSet.has(normalizedNote);
                let cellClass = 'fret-cell';
                if (isRoot) {
                    cellClass += ' root';
                } else if (isScaleNote) {
                    cellClass += ' in-scale';
                } else {
                    cellClass += ' out-of-scale';
                }
                html += `<div class="${cellClass}">${note}</div>`;
            }

            html += `</div>`;
        }

        html += `</div>`;
        return html;
    }

    // ==================== [SECTION 3: EVENT HANDLERS FOR UI] ====================
    // Description: Connects the musical tools to their input forms.

    // INTERVAL
    function handleIntervalCalc() {
        const note1 = document.getElementById('note1').value;
        const note2 = document.getElementById('note2').value;
        const result = document.getElementById('intervalResult');
        try {
            const [distance, intervalName] = getInterval(note1, note2);

            // Abbreviation map
            let abbrev = INTERVAL_ABBREVIATIONS[intervalName] || "";
            result.innerHTML = abbrev;
            result.style.display = 'block';
        } catch (err) {
            result.innerHTML = `<span style="color:red">${err.message}</span>`;
            result.style.display = 'block';
        }
    }

    // SCALE (and custom scale)
        function handleScaleGen() {
        const root = document.getElementById('scaleRoot').value;
        const scaleType = document.getElementById('scaleType').value;
        const result = document.getElementById('scaleResult');
        let isCustomScale = scaleType === "custom";
        let customIntervals = null;

        // Dynamically build the select options for all scales/chords/arpeggios defined in CHORD_SCALE_LIBRARY, SCALE_MODES, and PENTATONIC_MODES
        // This can be used to enhance the UI dropdown in addition to the handler

        // (If you want the dropdown options to be dynamic, consider replacing static <option>s in your HTML with code like this block:)
        // const scaleTypeSelect = document.getElementById('scaleType');
        // scaleTypeSelect.innerHTML = '';
        // const allTypes = { ...CHORD_SCALE_LIBRARY, ...SCALE_MODES, ...PENTATONIC_MODES };
        // Object.keys(allTypes).forEach(type => {
        //     const opt = document.createElement('option');
        //     opt.value = type;
        //     opt.textContent = type.replace(/_/g, " ").replace(/([a-z])/, v=>v.toUpperCase());
        //     scaleTypeSelect.appendChild(opt);
        // });
        // Custom and pentatonics could be handled with labels, etc.

        if (isCustomScale) {
            const customInput = document.getElementById('customScaleIntervals');
            if (customInput) {
                customIntervals = parseIntervalInput(customInput.value);
                if (!customIntervals || !customIntervals.length) {
                    result.innerHTML = `<span style="color:red">Please enter valid custom intervals (e.g. 2,2,1,2,2,2,1).</span>`;
                    result.style.display = 'block';
                    return;
                }
            } else {
                result.innerHTML = `<span style="color:red">Custom interval input box not found.</span>`;
                result.style.display = 'block';
                return;
            }
        }
        try {
            const scaleNotes = buildCustomScale(root, scaleType, customIntervals);

            // Properly prettify the chord/scale/arpeggio name, including for chords like sus2, sus4, major_triad, etc.
            let prettyScaleName = '';
            if (isCustomScale) {
                prettyScaleName = "Custom Scale";
            } else if (scaleType in CHORD_SCALE_LIBRARY) {
                // Chord or arpeggio
                // Add more formatting if desired (e.g. "min7b5" => "m7‚ô≠5", etc)
                prettyScaleName = scaleType
                    .replace(/_/g, ' ')
                    .replace(/major/i, "Major")
                    .replace(/minor/i, "Minor")
                    .replace(/maj7/gi, "Maj7")
                    .replace(/min7/gi, "Min7")
                    .replace(/m7b5/gi, "m7‚ô≠5")
                    .replace(/M7b5/gi, "M7‚ô≠5")
                    .replace(/m7/gi, "m7")
                    .replace(/7/gi, "7")
                    .replace(/dim7/gi, "dim7")
                    .replace(/augmented/gi, "Aug");
                prettyScaleName = prettyScaleName.charAt(0).toUpperCase() + prettyScaleName.slice(1);
            } else if (scaleType in SCALE_MODES || scaleType in PENTATONIC_MODES) {
                prettyScaleName = scaleType.replace(/_/g, " ").replace(/([a-z])/, v => v.toUpperCase());
            } else {
                prettyScaleName = scaleType;
            }

            const scaleLabel = `<strong>${root} ${prettyScaleName}:</strong>`;
            let noteRowHtml = `<div class="note-display">${scaleNotes.map((note, idx) => `<span class="note-item">${note}</span>`).join('')}</div>`;
            const diagramsButton = `<button class="button" id="showDiagramsBtn" style="margin-top:13px">Show 3 Fretboard Diagrams</button>`;
            result.innerHTML = scaleLabel + "<br>" + noteRowHtml + diagramsButton;
            result.style.display = 'block';

            // Attach the event for "Show 3 Fretboard Diagrams"
            setTimeout(() => {
                const btn = document.getElementById('showDiagramsBtn');
                if (btn) btn.onclick = () => {
                    showThreeDiagrams(root, scaleType, scaleNotes);
                };
            }, 1);
        } catch (err) {
            result.innerHTML = `<span style="color:red">${err.message}</span>`;
            result.style.display = 'block';
        }
    } 


    // FREQUENCY
        function handleFrequencyCalc() {
        const note = document.getElementById('freqNote').value;
        const octave = parseInt(document.getElementById('octave').value, 10);
        const result = document.getElementById('frequencyResult');
        try {
            const frequency = getFrequency(note, octave);
            result.innerHTML = `<strong>${note}${octave} Frequency:</strong><br>
                <span class="frequency-display">${frequency.toFixed(2)} Hz</span>`;
            result.style.display = 'block';
        } catch (err) {
            result.innerHTML = `<span style="color:red">${err.message}</span>`;
            result.style.display = 'block';
        }
    }

    // FRETBOARD
        function handleDrawFretboard() {
        // Render the selected scale on a 6-string standard guitar fretboard.
        // Each fret cell shows the concert pitch at that position. Scale tones are highlighted,
        // root and octave instances glow in lake blue, and octaves are connected by a subtle line.

        const root = document.getElementById('fretboardRoot').value;
        const scaleType = document.getElementById('fretboardScale').value;
        const fretMax = parseInt(document.getElementById('fretRange').value, 10);
        const result = document.getElementById('fretboardResult');
        try {
            // Determine scale notes
            let scaleNotes;
            if (scaleType === "custom" && document.getElementById('customScaleIntervals')) {
                const customIntervals = parseIntervalInput(document.getElementById('customScaleIntervals').value);
                scaleNotes = buildCustomScale(root, scaleType, customIntervals);
            } else {
                scaleNotes = buildCustomScale(root, scaleType);
            }

            const title = `${root} ${scaleType.replace('_', ' ').toUpperCase()} Scale Fretboard View`;
            const subtitle = `Scale notes: ${scaleNotes.join(', ')}`;
            result.innerHTML = buildFretboardHtml({
                root,
                title,
                subtitle,
                notes: scaleNotes,
                fretMax
            });
            result.style.display = 'block';
        } catch (err) {
            result.innerHTML = `<span style="color:red">${err.message}</span>`;
            result.style.display = 'block';
        }
    }

    function renderHome() {
        const main = document.querySelector('.main-content');
        if (!main) return;
        intervalPracticeState = null;
        intervalSequenceState = null;
        main.innerHTML = `
            <div class="home-menu">
                <h2 style="color:#2c3e50; text-shadow:0 0 6px rgba(0,0,0,0.08); text-align:center;">Choose a Music Theory Tool</h2>
                <button class="button" onclick="showIntervalPage()">Interval Trainer</button>
                <button class="button" onclick="showScalePage()">Scale Generator</button>
                <button class="button" onclick="showFrequencyPage()">Frequency Calculator</button>
                <button class="button" onclick="showFretboardPage()">Guitar Fretboard Visualizer</button>
                <button class="button" onclick="showArpeggiosPage()">Arpeggios & Chord Diagrams</button>
            </div>
        `;
    }

    function showIntervalPage() {
        const main = document.querySelector('.main-content');
        if (!main) return;
        main.innerHTML = `
            <div class="tool-section">
                <button class="button" onclick="renderHome()" style="margin-bottom:20px;">‚Üê Home</button>
                <h2>Interval Calculator</h2>
                <div class="input-group">
                    <label for="note1">First Note:</label>
                    <select id="note1">
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D">D</option>
                        <option value="D#">D#</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="note2">Second Note:</label>
                    <select id="note2">
                        <option value="E" selected>E</option>
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D">D</option>
                        <option value="D#">D#</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <button class="button" onclick="handleIntervalCalc()">Calculate Interval</button>
                <div id="intervalResult" class="result" style="display: none;"></div>
            </div>
            <div class="tool-section">
                <h3>Random Interval Practice</h3>
                <p id="intervalPracticePrompt" style="font-size:1.1em;"></p>
                <button class="button" id="intervalPracticeToggle" onclick="handleIntervalPracticeToggle()">Show</button>
                <div id="intervalPracticeAnswer" class="result" style="display:none; margin-top:15px;"></div>
                <div class="staff-wrapper" id="intervalStaffArea">
                    <div id="intervalStaffContainer"></div>
                    <button class="button" id="intervalStarBtn" onclick="handleIntervalSequenceStep()">‚≠ê Step</button>
                    <div id="intervalStepInfo" class="result" style="display:none;"></div>
                </div>
            </div>
        `;
        generateIntervalPractice();
    }

    function generateIntervalPractice() {
        const prompt = document.getElementById('intervalPracticePrompt');
        const answer = document.getElementById('intervalPracticeAnswer');
        const toggle = document.getElementById('intervalPracticeToggle');
        if (!prompt || !answer || !toggle) return;

        const startMidi = GUITAR_MIDI_NOTES[Math.floor(Math.random() * GUITAR_MIDI_NOTES.length)];
        const semitone = Math.floor(Math.random() * 12) + 1; // 1-12 semitones
        const intervalName = INTERVALS[semitone] || `${semitone} semitones`;
        const intervalAbbrev = INTERVAL_ABBREVIATIONS[intervalName] || `${semitone}`;

        let upMidi = startMidi + semitone;
        let downMidi = startMidi - semitone;
        if (upMidi > GUITAR_MAX_MIDI) upMidi = GUITAR_MAX_MIDI;
        if (downMidi < GUITAR_MIN_MIDI) downMidi = GUITAR_MIN_MIDI;
        intervalPracticeState = {
            showing: false,
            startMidi,
            startNote: noteNameFromMidi(startMidi),
            intervalName,
            intervalAbbrev,
            semitone,
            upNote: noteNameFromMidi(upMidi),
            downNote: noteNameFromMidi(downMidi)
        };

        prompt.innerHTML = `<strong>Start Note:</strong> ${intervalPracticeState.startNote}<br><strong>Interval:</strong> ${intervalPracticeState.intervalName} <span style="opacity:0.8;">(${intervalPracticeState.intervalAbbrev})</span>`;
        answer.style.display = 'none';
        answer.innerHTML = '';
        toggle.textContent = 'Show';
        initializeIntervalSequence(startMidi);
    }

    function handleIntervalPracticeToggle() {
        const answer = document.getElementById('intervalPracticeAnswer');
        const toggle = document.getElementById('intervalPracticeToggle');
        if (!answer || !toggle || !intervalPracticeState) return;

        if (!intervalPracticeState.showing) {
            answer.innerHTML = `
                <strong>Upward:</strong> ${intervalPracticeState.upNote}<br>
                <strong>Downward:</strong> ${intervalPracticeState.downNote}
            `;
            answer.style.display = 'block';
            toggle.textContent = 'Next';
            intervalPracticeState.showing = true;
        } else {
            generateIntervalPractice();
        }
    }

    function initializeIntervalSequence(startMidi) {
        const sequenceMidis = createIntervalSequence(startMidi);
        intervalSequenceState = {
            startMidi,
            notes: sequenceMidis.map(midi => ({
                midi,
                name: noteNameFromMidi(midi)
            })),
            clef: chooseClefForSequence(startMidi),
            currentIndex: -1
        };
        renderIntervalStaffDiagram();
        const info = document.getElementById('intervalStepInfo');
        if (info) info.style.display = 'none';
        const starBtn = document.getElementById('intervalStarBtn');
        if (starBtn) starBtn.textContent = '‚≠ê Step';
    }

    function chooseClefForSequence(startMidi) {
        return startMidi >= 57 ? 'treble' : 'bass';
    }

    function createIntervalSequence(startMidi) {
        const sequence = [startMidi];
        let currentMidi = startMidi;
        for (let i = 1; i < 12; i++) {
            let semitone = Math.floor(Math.random() * 11) + 1; // m2 to M7
            let direction = Math.random() < 0.5 ? -1 : 1;
            let candidate = currentMidi + direction * semitone;
            let attempts = 0;

            while ((candidate < GUITAR_MIN_MIDI || candidate > GUITAR_MAX_MIDI) && attempts < 12) {
                if (candidate < GUITAR_MIN_MIDI) {
                    direction = 1;
                } else if (candidate > GUITAR_MAX_MIDI) {
                    direction = -1;
                }
                if (semitone > 1) {
                    semitone = Math.max(1, semitone - 1);
                } else {
                    candidate = direction === 1 ? GUITAR_MIN_MIDI : GUITAR_MAX_MIDI;
                    break;
                }
                candidate = currentMidi + direction * semitone;
                attempts++;
            }

            candidate = Math.min(GUITAR_MAX_MIDI, Math.max(GUITAR_MIN_MIDI, candidate));
            sequence.push(candidate);
            currentMidi = candidate;
        }
        return sequence;
    }

    function renderIntervalStaffDiagram() {
        const container = document.getElementById('intervalStaffContainer');
        if (!container) return;
        if (!intervalSequenceState || !intervalSequenceState.notes || !intervalSequenceState.notes.length) {
            container.innerHTML = '';
            return;
        }

        const clef = intervalSequenceState.clef || 'treble';
        const config = STAFF_CONFIG[clef];
        const notes = intervalSequenceState.notes;
        const noteCount = notes.length;
        const width = config.leftMargin + config.noteSpacing * Math.max(0, noteCount - 1) + config.rightMargin;
        const height = config.height;
        const staffStartX = config.leftMargin;
        const staffEndX = width - config.rightMargin;
        const stepUnit = config.stepUnit;
        const baseLineY = config.baseLineY;

        const svgParts = [];

        // Background
        svgParts.push(`<rect x="0" y="0" width="${width}" height="${height}" rx="12" ry="12" fill="#ffffff" stroke="#2c3e50" stroke-width="1.5"/>`);

        // Staff lines
        for (let i = 0; i < 5; i++) {
            const y = baseLineY - i * config.lineSpacing;
            svgParts.push(`<line x1="${staffStartX}" y1="${y}" x2="${staffEndX}" y2="${y}" stroke="#2c3e50" stroke-width="1"/>`);
        }

        // Clef
        const clefYAdjust = clef === 'treble' ? 2.2 : 1.2;
        svgParts.push(`<text x="${config.leftMargin - 35}" y="${baseLineY - config.lineSpacing * clefYAdjust}" font-size="${config.clefFontSize}" fill="#2c3e50">${config.clefSymbol}</text>`);

        notes.forEach((note, index) => {
            const components = parseNoteComponents(note.name);
            if (!components) return;
            const diatonic = diatonicNumberFromComponents(components.letter, components.octave);
            const stepDiff = diatonic - config.referenceDiatonic;
            const x = config.leftMargin + index * config.noteSpacing;
            const y = baseLineY - stepDiff * stepUnit;

            const ledgerLines = computeLedgerLines(stepDiff, config, x);
            ledgerLines.forEach(line => svgParts.push(line));

            if (components.accidental) {
                svgParts.push(`<text x="${x - 16}" y="${y + 5}" font-size="18" fill="#2c3e50">${components.accidental}</text>`);
            }

            let fillColor = '#2c3e50';
            if (intervalSequenceState.currentIndex === index) {
                fillColor = '#f39c12';
            } else if (intervalSequenceState.currentIndex > index) {
                fillColor = '#95a5a6';
            }

        const stemHeight = 28;
        const stemX = x + 8;
        const stemTopY = y - stemHeight;
        svgParts.push(`<line x1="${stemX}" y1="${y}" x2="${stemX}" y2="${stemTopY}" stroke="#2c3e50" stroke-width="1"/>`);
        svgParts.push(`<path d="M ${stemX} ${stemTopY} q 8 6 0 12" fill="#2c3e50"/>`);

            svgParts.push(`<ellipse cx="${x}" cy="${y}" rx="8" ry="6" transform="rotate(-20 ${x} ${y})" fill="${fillColor}" stroke="#2c3e50" stroke-width="1.2"/>`);
        });

        const svg = `<div class="staff-card"><svg class="staff-svg" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">${svgParts.join('')}</svg></div>`;
        container.innerHTML = svg;
    }

    function computeLedgerLines(stepDiff, config, x) {
        const lines = [];
        const stepUnit = config.stepUnit;
        const baseLineY = config.baseLineY;

        if (stepDiff < config.minStep) {
            for (let lineStep = config.minStep - 2; lineStep >= stepDiff; lineStep -= 2) {
                if (lineStep < config.minStep) {
                    const y = baseLineY - lineStep * stepUnit;
                    lines.push(`<line x1="${x - 14}" y1="${y}" x2="${x + 14}" y2="${y}" stroke="#2c3e50" stroke-width="1"/>`);
                }
            }
        } else if (stepDiff > config.maxStep) {
            for (let lineStep = config.maxStep + 2; lineStep <= stepDiff; lineStep += 2) {
                if (lineStep > config.maxStep) {
                    const y = baseLineY - lineStep * stepUnit;
                    lines.push(`<line x1="${x - 14}" y1="${y}" x2="${x + 14}" y2="${y}" stroke="#2c3e50" stroke-width="1"/>`);
                }
            }
        }

        return lines;
    }

    function refreshIntervalSequence() {
        if (!intervalSequenceState) return;
        const sequenceMidis = createIntervalSequence(intervalSequenceState.startMidi);
        intervalSequenceState.notes = sequenceMidis.map(midi => ({
            midi,
            name: noteNameFromMidi(midi)
        }));
        intervalSequenceState.clef = chooseClefForSequence(intervalSequenceState.startMidi);
        intervalSequenceState.currentIndex = -1;
        renderIntervalStaffDiagram();
        const info = document.getElementById('intervalStepInfo');
        if (info) info.style.display = 'none';
        const starBtn = document.getElementById('intervalStarBtn');
        if (starBtn) starBtn.textContent = '‚≠ê Step';
    }

    function handleIntervalSequenceStep() {
        if (!intervalSequenceState || !intervalSequenceState.notes || !intervalSequenceState.notes.length) return;

        const info = document.getElementById('intervalStepInfo');

        if (intervalSequenceState.currentIndex >= intervalSequenceState.notes.length - 1) {
            refreshIntervalSequence();
            if (info) info.style.display = 'none';
            return;
        }

        intervalSequenceState.currentIndex += 1;
        renderIntervalStaffDiagram();

        if (intervalSequenceState.currentIndex > 0 && info) {
            const prev = intervalSequenceState.notes[intervalSequenceState.currentIndex - 1];
            const curr = intervalSequenceState.notes[intervalSequenceState.currentIndex];
            const semitoneDiff = Math.abs(curr.midi - prev.midi);
            const intervalName = INTERVALS[semitoneDiff] || `${semitoneDiff} semitones`;
            const intervalAbbrev = INTERVAL_ABBREVIATIONS[intervalName] || `${semitoneDiff}`;
            const direction = curr.midi > prev.midi ? 'up' : (curr.midi < prev.midi ? 'down' : 'unison');
            info.innerHTML = `<strong>${prev.name}</strong> ‚Üí <strong>${curr.name}</strong>: ${direction} ${intervalName} <span style="opacity:0.8;">(${intervalAbbrev})</span>`;
            info.style.display = 'block';
        } else if (info) {
            info.style.display = 'none';
        }
    }

    function showScalePage() {
        const main = document.querySelector('.main-content');
        if (!main) return;
        main.innerHTML = `
            <div class="tool-section">
                <button class="button" onclick="renderHome()" style="margin-bottom:20px;">‚Üê Home</button>
                <h2>Scale Generator</h2>
                <div class="input-group">
                    <label for="scaleRoot">Root Note:</label>
                    <select id="scaleRoot">
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D">D</option>
                        <option value="D#">D#</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="scaleType">Scale Type:</label>
                    <select id="scaleType">
                        <option value="ionian">Ionian (Major)</option>
                        <option value="dorian">Dorian</option>
                        <option value="phrygian">Phrygian</option>
                        <option value="lydian">Lydian</option>
                        <option value="mixolydian">Mixolydian</option>
                        <option value="aeolian">Aeolian (Natural Minor)</option>
                        <option value="locrian">Locrian</option>
                        <option value="harmonic_minor">Harmonic Minor</option>
                        <option value="melodic_minor">Melodic Minor</option>
                        <option value="ionian_pentatonic">Major Pentatonic</option>
                        <option value="aeolian_pentatonic">Minor Pentatonic</option>
                    </select>
                </div>
                <button class="button" onclick="handleScaleGen()">Generate Scale</button>
                <div id="scaleResult" class="result" style="display: none;"></div>
            </div>
        `;
    }

    function showFrequencyPage() {
        const main = document.querySelector('.main-content');
        if (!main) return;
        main.innerHTML = `
            <div class="tool-section">
                <button class="button" onclick="renderHome()" style="margin-bottom:20px;">‚Üê Home</button>
                <h2>Note Frequency Calculator</h2>
                <div class="input-group">
                    <label for="freqNote">Note:</label>
                    <select id="freqNote">
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D">D</option>
                        <option value="D#">D#</option>
                        <option value="E">E</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A" selected>A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="octave">Octave:</label>
                    <input type="number" id="octave" value="4" min="0" max="8">
                </div>
                <button class="button" onclick="handleFrequencyCalc()">Calculate Frequency</button>
                <div id="frequencyResult" class="result" style="display: none;"></div>
            </div>
        `;
    }

    function showFretboardPage() {
        const main = document.querySelector('.main-content');
        if (!main) return;
        main.innerHTML = `
            <div class="tool-section">
                <button class="button" onclick="renderHome()" style="margin-bottom:20px;">‚Üê Home</button>
                <h2>Guitar Fretboard Visualizer</h2>
                <div class="input-group">
                    <label for="fretboardRoot">Root Note for Scale:</label>
                    <select id="fretboardRoot">
                        <option value="E">E</option>
                        <option value="C">C</option>
                        <option value="C#">C#</option>
                        <option value="D">D</option>
                        <option value="D#">D#</option>
                        <option value="F">F</option>
                        <option value="F#">F#</option>
                        <option value="G">G</option>
                        <option value="G#">G#</option>
                        <option value="A">A</option>
                        <option value="A#">A#</option>
                        <option value="B">B</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="fretboardScale">Scale Type:</label>
                    <select id="fretboardScale">
                        <option value="aeolian">Aeolian (Natural Minor)</option>
                        <option value="ionian">Ionian (Major)</option>
                        <option value="dorian">Dorian</option>
                        <option value="phrygian">Phrygian</option>
                        <option value="lydian">Lydian</option>
                        <option value="mixolydian">Mixolydian</option>
                        <option value="locrian">Locrian</option>
                        <option value="harmonic_minor">Harmonic Minor</option>
                        <option value="melodic_minor">Melodic Minor</option>
                        <option value="aeolian_pentatonic">Minor Pentatonic</option>
                        <option value="ionian_pentatonic">Major Pentatonic</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="fretRange">Fret Range:</label>
                    <input type="range" id="fretRange" min="0" max="22" value="12" oninput="handleUpdateFretboard()">
                    <span id="fretRangeValue">12</span> frets
                </div>
                <button class="button" onclick="handleDrawFretboard()">Show Fretboard</button>
                <div id="fretboardResult" class="fretboard" style="display: none;"></div>
            </div>
        `;
        handleUpdateFretboard();
    }

    // SHOW THREE DIAGRAMS
    // All row indices: 0 = BOTTOM (E string), 1 = A, 2 = D, 3 = TOP (G string)
    function showThreeDiagrams(root, scaleType, scaleNotes) {
        const result = document.getElementById('scaleResult');
        try {
            // Box dimensions: 7 horizontal x 4 vertical
            const gridW = 7;
            const gridH = 4;
            const cellSize = 45;
            const cellGap = 3;
            const deepBlue = "#154d8b";
            const lakeBlue = "#4ab3ff";
            const lightGray = "#f0f0f0";

            // Starting positions for each diagram (row 0 is BOTTOM E string up to row 3 top G string)
            const diagrams = [
                { label: "Left", startPos: 5, maxNotes: [1, 3, 3, 3] },   // [E, A, D, G] max notes ‚Äî row 0 = E, row 3 = G
                { label: "Middle", startPos: 2, maxNotes: [2, 3, 3, 3] },
                { label: "Right", startPos: 0, maxNotes: [3, 3, 3, 3] }
            ];

            // Get scale intervals
            let intervals;
            if (scaleType.includes("pentatonic")) {
                let base = scaleType.replace("_pentatonic", "");
                intervals = PENTATONIC_MODES[base] || PENTATONIC_MODES["ionian"];
            } else {
                intervals = SCALE_MODES[scaleType] || SCALE_MODES["ionian"];
            }

            // Function to build one diagram (row 0 is bottom, row 3 is top)
            function buildDiagram(startPos, maxNotes) {
                let box = Array.from({ length: gridH }, () => Array(gridW).fill(null));
                let notesOnRow = [1, 0, 0, 0]; // E (bottom) to G (top)
                let currentRow = 0; // Start from lowest row (E string, bottom)
                let currentCol = startPos;
                let scaleDegree = 0;
                let accumulatedRows = 0;
                let octaveReached = false;

                // Place root note at start position
                box[currentRow][currentCol] = {
                    note: scaleNotes[0],
                    degree: 1,
                    isRoot: true
                };
                notesOnRow[currentRow] = 1;
                scaleDegree = 1;

                // Continue generating until octave is placed
                while (!octaveReached) {
                    // 1. Check if current row exceeded note max
                    if (notesOnRow[currentRow] < maxNotes[currentRow]) {
                        // Move horizontally to the right based on the interval (m2: 1 step, M2: 2 steps, m3: 3 steps, etc)
                        let interval = intervals[(scaleDegree - 1) % intervals.length];
                        // According to instructions: m2=1 step, M2=2 steps. 
                        // We'll interpret "m2 = interval==1", "M2 = interval==2"
                        let horizontalSteps;
                        if (interval === 1) {
                            horizontalSteps = 1; // m2
                        } else if (interval === 2) {
                            horizontalSteps = 2; // M2
                        } else {
                            // For other intervals (e.g. m3=3), go by steps = interval size
                            horizontalSteps = interval;
                        }
                        let nextCol = currentCol + horizontalSteps;
                        // Check horizontal bounds
                        if (nextCol >= gridW) break;

                        // nextRow is the same
                        let nextRow = currentRow;

                        let degree = scaleDegree + 1;
                        let isRoot = false;
                        let noteName;

                        if (scaleDegree === intervals.length) {
                            // This is the octave (root again)
                            degree = 8;
                            noteName = root;
                            isRoot = true;
                            octaveReached = true;
                        } else {
                            noteName = scaleNotes[scaleDegree % scaleNotes.length];
                        }

                        box[nextRow][nextCol] = {
                            note: noteName,
                            degree: degree,
                            isRoot: isRoot
                        };

                        notesOnRow[nextRow] += 1;
                        currentCol = nextCol;
                        // currentRow stays the same
                        scaleDegree++;
                    } else {
                        // Yes: move to next row above (row+1), column +1 and adjust further left
                        // Determine previous interval: it's the interval to reach this next degree
                        let intervalType = intervals[(scaleDegree - 1) % intervals.length];
                        let intervalShift;
                        // M2 = 2 -> shift -3, m2 = 1 -> shift -4, m3 = 3 -> shift -2
                        if (intervalType === 2) {
                            intervalShift = -4;
                        } else if (intervalType === 1) {
                            intervalShift = -5;
                        } else if (intervalType === 3) {
                            intervalShift = -3;
                        } else {
                            intervalShift = -4;
                        }

                        let nextRow = currentRow + 1; // move UP (next string above)
                        let nextCol = currentCol + 1 + intervalShift;

                        if (nextRow >= gridH || nextCol < 0 || nextCol >= gridW) break; // out of bounds

                        let degree = scaleDegree + 1;
                        let isRoot = false;
                        let noteName;

                        if (scaleDegree === intervals.length) {
                            degree = 8;
                            noteName = root;
                            isRoot = true;
                            octaveReached = true;
                        } else {
                            noteName = scaleNotes[scaleDegree % scaleNotes.length];
                        }

                        if (notesOnRow[nextRow] >= maxNotes[nextRow]) break; // can't put on this row

                        box[nextRow][nextCol] = {
                            note: noteName,
                            degree: degree,
                            isRoot: isRoot
                        };
                        notesOnRow[nextRow] += 1;
                        currentRow = nextRow;
                        currentCol = nextCol;
                        scaleDegree++;
                        accumulatedRows++;
                    }
                }

                return box;
            }

            // Function to render one diagram
            function renderDiagram(box, label) {
                let cellsHtml = '';
                for (let displayRow = gridH - 1; displayRow >= 0; displayRow--) {
                    for (let col = 0; col < gridW; col++) {
                        let cell = box[displayRow][col];
                        let cellStyle = `width:${cellSize}px; height:${cellSize}px; border:1px solid #ccc; display:flex; align-items:center; justify-content:center; font-size:15px; font-weight:500; font-family:'Segoe UI', Arial, sans-serif;`;

                        if (cell) {
                            let bgColor;
                            let textColor;
                            if (cell.isRoot) {
                                bgColor = lakeBlue;
                                textColor = "#03253a";
                            } else if (cell.degree % 2 === 1) {
                                bgColor = deepBlue;
                                textColor = "#fff";
                            } else {
                                bgColor = lightGray;
                                textColor = "#000";
                            }
                            cellStyle += `background-color:${bgColor}; color:${textColor};`;
                            cellsHtml += `<div style="${cellStyle}">${cell.note}</div>`;
                        } else {
                            cellsHtml += `<div style="${cellStyle}">¬∑</div>`;
                        }
                    }
                }

                return `
                    <div style="display:inline-block; margin:20px; padding:15px; border:2px solid #333; border-radius:8px; background:#f9f9f9;">
                        <h4 style="text-align:center; margin:0 0 10px 0; color:#333;">${label}</h4>
                        <div style="display:grid; grid-template-columns: repeat(${gridW}, ${cellSize}px); grid-template-rows: repeat(${gridH}, ${cellSize}px); gap:${cellGap}px;">
                            ${cellsHtml}
                        </div>
                    </div>
                `;
            }

            // Build and render all diagrams
            let html = `<div style="text-align:center;">
                <h3>${root} ${scaleType.replace('_',' ').toUpperCase()} - Three Fretboard Positions</h3>
                <p>Scale notes: ${scaleNotes.join(', ')}</p>
                <div style="display:flex; justify-content:center; flex-wrap:wrap; margin-top:20px;">
            `;

            diagrams.forEach(diagram => {
                let box = buildDiagram(diagram.startPos, diagram.maxNotes);
                html += renderDiagram(box, diagram.label);
            });

            html += `</div></div>`;

            result.innerHTML = html;
            result.style.display = 'block';
        } catch (err) {
            result.innerHTML = `<span style="color:red">Error showing diagrams: ${err.message}</span>`;
            result.style.display = 'block';
        }
    }
    // ============================================
    //  [Section: ARPEGGIOS PAGE LINK AND SECTION]
    // ============================================
    // Add Arpeggios section to the website upon DOMContentLoaded
    document.addEventListener('DOMContentLoaded', () => {
        // Add Arpeggio button to the main content if not present
        if (!document.getElementById('arpeggiosNav')) {
            const btn = document.createElement('button');
            btn.id = 'arpeggiosNav';
            btn.className = 'button';
            btn.style.margin = '25px 0 0 0';
            btn.innerText = 'Arpeggios';
            btn.onclick = () => { showArpeggiosPage(); };
            document.querySelector('.header').appendChild(btn);
        }
    });

    /**
     * ============[ ARPEGGIOS PAGE: UI and CONTENT ]============
     * Renders a page with explanations and interactive section
     * for pentatonic, blues, sus, 7th, 9th, and Japanese scales.
     */
    function showArpeggiosPage() {
        // "Open a new page": clear the main-content area and display arpeggios tools
        let main = document.querySelector('.main-content');
        if (!main) return;

        main.innerHTML = `
            <button class="button" onclick="renderHome()" style="margin-bottom:20px;">‚Üê Home</button>
            <h2>Arpeggios, Chords, and Pentatonic Modes Generator</h2>
            <p>
              <b>Explore generations of major, minor, pentatonics (major/minor/blues), <br>
              Japanese pentatonic, all supported 7th, sus2, sus4, and 9th chords.</b> <br>
              <br>
              <b>Japanese pentatonic:</b> <br>
              Commonly called "yo" scale with semitone positions: 0, +1, +5, +7, +10 <br>
              Step pattern: +1, +4, +2, +3, +2 (returns to octave)
              <pre style="margin:4px 0 0 0; padding:6px; background:#f0f0f080;">
      Example: C Japanese Pentatonic: C C# F G Bb
              </pre>
            </p>
            <style>
              .arp-option-group {margin-bottom: 10px;}
              .arp-option-group label {font-size: 1.35em;}
              .arp-select {padding:11px 16px; border-radius:6px; font-size:1.35em;}
              .arp-diagram-wrap {margin-top: 14px;}
              .arp-groups {margin-top: 22px; display:flex; flex-direction:column; gap:26px;}
              .arp-group-title {font-size:1.3em; font-weight:bold; margin-bottom:10px;}
              .arp-group-row {display:flex; flex-wrap:wrap; gap:16px; justify-content:center;}
            </style>
            <div class="tool-section">
              <h3>Choose chord or scale type:</h3>
              <div class="arp-option-group">
                <label>Root:
                  <select id="arpRoot" class="arp-select">
                    <option>C</option><option>C#</option><option>D</option><option>Eb</option>
                    <option>E</option><option>F</option><option>F#</option><option>G</option>
                    <option>Ab</option><option>A</option><option>Bb</option><option>B</option>
                  </select>
                </label>
                <label>Type:
                  <select id="arpType" class="arp-select">
                    <optgroup label="Pentatonic scales">
                      <option value="major_pentatonic">Major Pentatonic</option>
                      <option value="minor_pentatonic">Minor Pentatonic</option>
                      <option value="blues_pentatonic">Blues (Minor) Pentatonic</option>
                      <option value="japanese_pentatonic">Japanese Pentatonic (Yo)</option>
                    </optgroup>
                    <optgroup label="Triads">
                      <option value="major_triad">Major Triad</option>
                      <option value="minor_triad">Minor Triad</option>
                      <option value="diminished_triad">Diminished Triad</option>
                      <option value="augmented_triad">Augmented Triad</option>
                    </optgroup>
                    <optgroup label="7th/9th Chords">
                      <option value="maj7">Major 7th</option>
                      <option value="min7">Minor 7th</option>
                      <option value="dom7">Dominant 7th</option>
                      <option value="maj9">Major 9th</option>
                      <option value="min9">Minor 9th</option>
                      <option value="dom9">Dominant 9th</option>
                      <option value="half_diminished7">Half-diminished 7th</option>
                      <option value="fully_diminished7">Fully diminished 7th</option>
                      <option value="M7b5">Major 7‚ô≠5</option>
                      <option value="M7#5">Major 7‚ôØ5</option>
                      <option value="minor_major7">Minor Major 7th</option>
                      <option value="french_aug6">French Augmented 6th</option>
                      <option value="german_aug6">German Augmented 6th</option>
                      <option value="italian_aug6">Italian Augmented 6th</option>
                      <option value="M7sus4">Major 7 sus4</option>
                      <option value="M7sus2">Major 7 sus2</option>
                    </optgroup>
                    <optgroup label="Suspended chords">
                      <option value="sus2">Sus2</option>
                      <option value="sus4">Sus4</option>
                    </optgroup>
                  </select>
                </label>
                <button class="button" onclick="generateArpDiagram()">Generate</button>
              </div>
              <div id="arpDiagramRes" class="arp-diagram-wrap"></div>
            </div>
        `;
    }

    // =========================================
    //    [SECTION: CHORD & SCALE LIBRARY]
    // =========================================
    // Intervals in semitones for all libraries (pentatonic, blues, Japanese, chords, etc)
    // (Blues = Minor Pentatonic with an added b5 between 4th and 5th - for diagramming, keep 5-note shape)
    const ARP_LIB = {
        'major_pentatonic':      { intervals: [2,2,3,2,3],    name: "Major Pentatonic" }, // 1-2-3-5-6
        'minor_pentatonic':      { intervals: [3,2,2,3,2],    name: "Minor Pentatonic" }, // 1-b3-4-5-b7
        'blues_pentatonic':      { intervals: [3,2,1,1,3,2],  name: "Blues (6-note!)" },  // 1-b3-4-b5-5-b7
        'japanese_pentatonic':   { intervals: [1,4,2,3,2],    name: "Japanese Pentatonic (Yo)" },
        'major_triad':           { intervals: [4,3],           name: "Major Triad (1-3-5)" },
        'minor_triad':           { intervals: [3,4],           name: "Minor Triad (1-b3-5)" },
        'diminished_triad':      { intervals: [3,3],           name: "Diminished Triad (1-b3-b5)" },
        'augmented_triad':       { intervals: [4,4],           name: "Augmented Triad (1-3-#5)" },
        // Chord intervals: from root, as steps (stacked)
        // 7th and 9th chords
        'maj7':     { intervals: [4,3,4],  name: "Major 7th (1-3-5-7)" },   // 1-3-5-7
        'min7':     { intervals: [3,4,3],  name: "Minor 7th (1-b3-5-b7)" },
        'dom7':     { intervals: [4,3,3],  name: "Dominant 7th (1-3-5-b7)" },
        'minor_major7': { intervals: [3,4,4],  name: "Minor-Major 7th (1-b3-5-7)" },
        'maj9':     { intervals: [4,3,4,3],  name: "Major 9th (1-3-5-7-9)" },
        'min9':     { intervals: [3,4,3,4],  name: "Minor 9th (1-b3-5-b7-9)" },
        'dom9':     { intervals: [4,3,3,4],  name: "Dominant 9th (1-3-5-b7-9)" },
        'half_diminished7': { intervals: [3,3,4], name: "Half-diminished 7th (1-b3-b5-b7)" },
        'fully_diminished7': { intervals: [3,3,3], name: "Fully diminished 7th (1-b3-b5-bb7)" },
        'M7b5':     { intervals: [4,2,5],  name: "Major 7‚ô≠5 (1-3-b5-7)" },
        'M7#5':     { intervals: [4,4,3],  name: "Major 7‚ôØ5 (1-3-#5-7)" },
        'M7sus4':   { intervals: [5,2,4],  name: "Major 7 sus4 (1-4-5-7)" },
        'M7sus2':   { intervals: [2,5,4],  name: "Major 7 sus2 (1-2-5-7)" },
        'french_aug6': { intervals: [4,2,4], name: "French Augmented 6th (1-3-#4-#6)" },
        'german_aug6': { intervals: [4,3,3], name: "German Augmented 6th (1-3-5-#6)" },
        'italian_aug6': { intervals: [4,6],   name: "Italian Augmented 6th (1-3-#6)" },
        // Suspended
        'sus2':     { intervals: [2,5,5], name: "Suspended 2nd (1-2-5)" },
        'sus4':     { intervals: [5,2,5], name: "Suspended 4th (1-4-5)" }
    };

    // Map for degrees to names (for display)
    const DEGREE_NAMES = ["1", "b2/#1", "2", "b3", "3", "4", "b5", "5", "#5/b6", "6", "b7", "7", "8"];

    // All chromatic notes (for enharmonics, but simple version)
    const CHROMATIC_NOTES = ["C","C#","D","Eb","E","F","F#","G","Ab","A","Bb","B"];
    const ENHARMONIC_EQUIVS = { 'Eb': 'D#', 'Bb': 'A#', 'Ab': 'G#' };
    function noteIndexOf(n) { return CHROMATIC_NOTES.indexOf(n); }
    function mod12(i) { let m = i % 12; return m < 0 ? m + 12 : m; }
    function normalizeNoteName(note) {
        return ENHARMONIC_EQUIVS[note] || note;
    }
    function getNoteByInterval(root, intervalArr) {
        // Returns array of notes by adding up intervals from root
        let idx = noteIndexOf(root);
        let result = [root];
        let sum = 0;
        for (let i = 0; i < intervalArr.length; ++i) {
            sum += intervalArr[i];
            result.push(CHROMATIC_NOTES[mod12(idx + sum)]);
        }
        return result;
    }
    function pentatonicScaleNotes(root, pentType) {
        // Fix: always start at root, and take proper N=5 notes
        let arr = ARP_LIB[pentType].intervals.slice(0,5);
        let notes = [root];
        let idx = noteIndexOf(root);
        let sum = 0;
        for (let i = 0; i < arr.length-1; ++i) { // do only 4 intervals: root to 2, 2 to 3,...
            sum += arr[i];
            notes.push(CHROMATIC_NOTES[mod12(idx + sum)]);
        }
        return notes; // Will always be 5
    }
    function bluesScaleNotes(root) {
        // Blues is 6 notes: 1, b3, 4, b5, 5, b7
        // [3,2,1,1,3,2]
        let arr = ARP_LIB['blues_pentatonic'].intervals;
        let notes = [root];
        let idx = noteIndexOf(root);
        let sum = 0;
        for (let i = 0; i < arr.length-1; ++i) {
            sum += arr[i];
            notes.push(CHROMATIC_NOTES[mod12(idx + sum)]);
        }
        return notes; // 6
    }


    // =================================================
    //   [SECTION: ARPEGGIO DIAGRAM GENERATOR LOGIC]
    // =================================================
    // Generates a 7x4 mini "box" grid, following fretboard logic and pentatonic/jump rules as in instructions.

    function generateArpDiagram() {
        // Gather selection
        const root = document.getElementById('arpRoot').value;
        const type = document.getElementById('arpType').value;
        const out = document.getElementById('arpDiagramRes');
        let info = ARP_LIB[type];
        if (!info) { out.innerHTML = "<span style='color:red'>Type not found.</span>"; return; }
        let notes, dispType, label;
        let isPent = type.includes("pentatonic");
        let isBlues = type === 'blues_pentatonic';
        // ------[1. Get scale/chord notes]------
        if (isPent && !isBlues) {
            notes = pentatonicScaleNotes(root, type);
            dispType = info.name;
        } else if (isBlues) {
            notes = bluesScaleNotes(root);
            dispType = info.name;
        } else if (type === 'japanese_pentatonic') {
            notes = pentatonicScaleNotes(root, type);  // same as other pentatonics
            dispType = info.name;
        } else {
            notes = getNoteByInterval(root, info.intervals);
            dispType = info.name;
        }
        label = `<div><b>${root} ${dispType}</b><br><span style="font-size:1.1em;">Notes: ${notes.join(", ")}</span></div>`;

        // ------[2. Render Diagrams]------
        const offsets = [0, 2, 4];
        const unlimitedNotes = [null, null, null, null, null, null];
        const stringGroups = [
            { title: "E String Root Positions", startString: 0 },
            { title: "A String Root Positions", startString: 1 },
            { title: "D String Root Positions", startString: 2 },
            { title: "G String Root Positions", startString: 3 },
        ];

        let html = label + `<div class="arp-groups">`;
        stringGroups.forEach(group => {
            html += `<div class="arp-group"><div class="arp-group-title">${group.title}</div><div class="arp-group-row">`;
            offsets.forEach((offset, idx) => {
                const grid = arpBoxGrid(root, info.intervals, offset, group.startString, unlimitedNotes, type);
                const diagLabel = `Position ${idx + 1} (offset +${offset})`;
                html += renderArpGrid(grid, diagLabel, notes, info.name, type);
            });
            html += `</div></div>`;
        });
        html += `</div>`;

        const fretboardSection = buildFretboardHtml({
            root,
            title: `${root} ${dispType} Fretboard`,
            subtitle: `Notes: ${notes.join(', ')}`,
            notes,
            fretMax: 19
        });
        html += `<div class="fretboard" style="margin-top:26px;">${fretboardSection}</div>`;

        out.innerHTML = html;
    }

    // ======================================================
    //   [SECTION: FRETBBOARD BOX NOTE GENERATOR - REVISED]
    // ======================================================
    // See prompt (rules for pentatonic jumping!)
    function arpBoxGrid(root, intervals, rootColumn, startStringIndex, maxNotes, scaleType) {
        const gridW = 5, gridH = 6;
        const strings = ['E', 'A', 'D', 'G', 'B', 'E'];
        const stringOffsets = [0, 5, 10, 15, 19, 24];
        const box = Array.from({ length: gridH }, () => Array(gridW).fill(null));

        const rootIndex = NOTE_TO_INDEX[root];
        if (typeof rootIndex === 'undefined') {
            return box;
        }

        const startStringNoteIndex = NOTE_TO_INDEX[strings[startStringIndex]];
        if (typeof startStringNoteIndex === 'undefined') {
            return box;
        }
        let rootFret = (rootIndex - startStringNoteIndex + 12) % 12;
        while (rootFret < rootColumn) {
            rootFret += 12;
        }
        const fretOffset = rootFret - rootColumn;

        for (let row = 0; row < gridH; row++) {
            for (let col = 0; col < gridW; col++) {
                const fretNumber = col + fretOffset;
                if (fretNumber < 0) continue;
                const noteName = getFretNote(strings[row], fretNumber);
                const pitchNumber = stringOffsets[row] + fretNumber;
                box[row][col] = {
                    note: noteName,
                    pitch: pitchNumber,
                    show: false,
                    degree: null,
                    isRoot: false
                };
            }
        }

        let rootPitchTarget = stringOffsets[startStringIndex] + rootFret;
        let rootCell = { row: startStringIndex, col: rootColumn };
        if (!box[rootCell.row] || !box[rootCell.row][rootCell.col] || box[rootCell.row][rootCell.col].note !== root) {
            outer:
            for (let row = 0; row < gridH; row++) {
                for (let col = 0; col < gridW; col++) {
                    const cell = box[row][col];
                    if (!cell) continue;
                    if (cell.note === root) {
                        rootCell = { row, col };
                        rootPitchTarget = cell.pitch;
                        break outer;
                    }
                }
            }
        } else {
            rootPitchTarget = box[rootCell.row][rootCell.col].pitch;
        }

        if (!box[rootCell.row] || !box[rootCell.row][rootCell.col]) {
            return box;
        }

        const intervalSequence = (() => {
            if (scaleType === 'blues_pentatonic') return [3, 2, 1, 1, 3, 2];
            if (scaleType.includes('pentatonic')) return ARP_LIB[scaleType].intervals.slice(0, 5);
            return Array.isArray(intervals) ? intervals.slice() : [];
        })();

        const semitoneSet = new Set([0]);
        let cumulative = 0;
        intervalSequence.forEach(step => {
            cumulative = (cumulative + step) % 12;
            semitoneSet.add(cumulative);
        });

        for (let row = 0; row < gridH; row++) {
            for (let col = 0; col < gridW; col++) {
                const cell = box[row][col];
                if (!cell) continue;
                const diff = cell.pitch - rootPitchTarget;
                if (diff < 0) continue;
                const normalized = ((diff % 12) + 12) % 12;
                if (!semitoneSet.has(normalized)) continue;
                if (maxNotes[row] !== null && typeof maxNotes[row] === 'number' && maxNotes[row] >= 0) {
                    const existing = box[row].filter(c => c && c.show).length;
                    if (existing >= maxNotes[row]) continue;
                }
                cell.show = true;
                cell.isRoot = normalized === 0;
            }
        }

        return box;
    }


    // ==================================
    // [SECTION: DIAGRAM RENDER FUNCTION]
    // ==================================
    function renderArpGrid(box, label, notes, typename, scaleType) {
        const gridW = 5, gridH = 6, cellSize = 32;
        const deepBlue = "#154d8b", black = "#211c1a", lightGray = "#f5f5f5", pink="#c0a4d6";
        let html = `
            <div style="display:inline-block; margin:12px 7px; padding:13px 9px; border:2px solid #332b48; border-radius:8px; background:#fefefeff;">
                <div style="text-align:center;font-weight:bold;font-size:1.02em;margin-bottom:3px;">${label}</div>
                <div style="display:grid; grid-template-columns: repeat(${gridW}, ${cellSize}px); grid-template-rows: repeat(${gridH}, ${cellSize}px); gap:2px;">
        `;
        for (let r = gridH-1; r >= 0; r--) {
            for (let c = 0; c < gridW; ++c) {
                let cell = box[r][c];
                let cellStyle = `width:${cellSize}px;height:${cellSize}px;border:1px solid #bbb;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:bold;border-radius:7px;`;
                if(cell && cell.show){
                    let bg = lightGray;
                    let text = "#21344a";
                    let content = cell.note;
                    if(cell.isRoot) { bg=pink; text="#2c213e"; }
                    cellStyle+=`background-color:${bg};color:${text};`;
                    html+=`<div style="${cellStyle}" title="${cell.isRoot ? 'Root' : 'Scale note'}">${content}</div>`;
                }else{
                    html+=`<div style="${cellStyle}">¬∑</div>`;
                }
            }
        }
        html+=`</div>`;
        html+=`<div style="margin-top:4px;font-size:0.97em;color:#555;text-align:center;">${typename}</div>`;
        html+=`</div>`;
        return html;
    }

    // End of Section

    function handleUpdateFretboard() {
        const fretRangeInput = document.getElementById('fretRange');
        if (!fretRangeInput) {
            return;
        }

        const fretRangeValue = document.getElementById('fretRangeValue');
        if (fretRangeValue) {
            fretRangeValue.textContent = fretRangeInput.value;
        }

        const fretboardResult = document.getElementById('fretboardResult');
        if (fretboardResult && fretboardResult.style.display === 'block') {
            handleDrawFretboard();
        }
    }

    // =========================
    //   INITIALIZE
    // =========================
    document.addEventListener('DOMContentLoaded', () => {
        renderHome();
    });
    </script>
</body>
</html>

